#! /bin/zsh
# (zsh is needed for the nice += array syntax)
# This script notifies the user if there were high priority errors in the last
# hour. It should be run on a regular basis (for example trough a systemd
# timer).

# Patterns to ignore
# Start message
exclude=()
exclude+='^-- Logs begin at \w{3} [0-9]{4}\-[0-9]{2}\-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2} \w+\. --'
# Happens every time HDMI is removed from my laptop, probably only something the laptop does to save energy
exclude+='^\w{3} [0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2} \w+ seq [0-9]+ ''/devices/pci0000:00/0000:00:02.0/drm/card0'' killed$'
exclude+='^\w{3} [0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2} \w+ worker \[[0-9]+\] failed while handling ''/devices/pci0000:00/0000:00:02.0/drm/card0'''
# This seems to be a bug in the radeon driver that occurs when returning from suspend
exclude+='^\w{3} [0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2} \w+ kernel: \[drm:si_dpm_set_power_state \[radeon\]\] \*ERROR\* si_set_sw_state failed'
exclude+='^\w{3} [0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2} \w+ kernel: \[drm:radeon_pm_late_init \[radeon\]\] \*ERROR\* failed to create device file for \w+ \w+$'
# This occurs when pluggin in an USB-Drive that doesn't support caching
exclude+='^\w{3} [0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2} \w+ kernel: sd [0-9]+:0:0:0: \[s\w\w\] No Caching mode page found$'
exclude+='^\w{3} [0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2} \w+ kernel: sd [0-9]+:0:0:0: \[s\w\w\] Assuming drive cache: write through$'
# Apparently a not so important warning (see
# http://www.spinics.net/lists/intel-gfx/msg81325.html)
exclude+='^\w{3} [0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2} \w+ kernel: \[drm:gen8_irq_handler \[i915\]\] *ERROR* The master control interrupt lied (SDE)!$'

journalctl -b --priority=0..3 --since=-10h --follow --no-pager | while read line
do
	blocked=false
	for pattern in "${exclude[@]}" ; do
		if [[ $line =~ $pattern ]] ; then
			blocked=true
		fi
	done
	if ! $blocked ; then
		notify-send -- "$line"
	fi
done
