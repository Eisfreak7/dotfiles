#!/usr/bin/env python

# based on
# share/bash-completion/completions/man

def mandirs():
    return $(manpath).strip().split(':')

def manfiles():
    files = set()
    for mandir in mandirs():
        for section in range(1,9):
            cur_dir = os.path.join(mandir, 'man{}'.format(section))
            if os.path.isdir(cur_dir):
                for manpage in os.listdir(cur_dir):
                    split = manpage.split('.')
                    # sec = split[-2] # may not equal the actual section
                    name = '.'.join(split[:-2])
                    files.add(manpage)
    return files

comprsuffix = r'(?:[glx]z|bz2|lzma|Z)'
manext = r'(?:[0-9lnp]|[0-9][px]|man|3?(?:gl|pm))'
mansect = r'(?:[0-9lnp]|[0-9][px]|3?(gl|pm))'
parser_regex = r'(?P<pagename>.+?)(?P<manext>\.{manext})?(?P<comprsuffix>\.{comprsuffix})?$'.format(manext=manext, comprsuffix=comprsuffix)
parser_regex_compiled = re.compile(parser_regex)

def parse_man_filename(filename):
    match = parser_regex_compiled.match(filename)
    return (match.group('pagename'), match.group('manext'), match.group('comprsuffix'))

def manpages():
    return { parse_man_filename(filename) for filename in manfiles() }

def man_page_completer(prefix, line, begidx, endidx, ctx):
    cmd = line.split()[0]
    if cmd != 'man':
        return None
    words_before = line[:begidx].split()
    previous = words_before[-1] if len(words_before) > 0 else None
    if previous in [ '-C', '-config-file' ]:
        pass # TODO
    elif previous in [ '-l', '--local-file' ]:
        pass # TODO
    elif previous in [ '-M', '--manpath' ]:
        pass # TODO
    elif previous in [ '-P', '--pager' ]:
        pass # TODO
    elif previous in [ '-p', '--preprocessor' ]:
        pass # TODO
    elif previous in [
            '-L', '--locale', '-m', '--systems', '-e', '--extension', '-r', '--prompt', '-R', '--recode', '-E', '--encoding'
    ]:
        return None # can't handle those
    else:
        return { name for (name, sec, _) in manpages() if name.startswith(prefix) }

# completer add man_page_completer man_page_completer
